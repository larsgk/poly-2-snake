<link rel="import" href="bower_components/polymer/polymer-element.html">
<link rel="import" href="bower_components/paper-button/paper-button.html">
<link rel="import" href="poly-snake-part.html">

<dom-module id="poly-snake">
  <template>
  <h2>[[direction]]</h2>

  <canvas id="canvas" width="512" height="512"></canvas>

    <dom-repeat items="[[snake]]">
      <template><poly-snake-part data="[[item]]" ctx="[[ctx]]"></poly-snake-part><br></template>
    </dom-repeat>
  </template>

  <script>

    const _KEY_DIR = {
      "TL": ["KeyW", "Numpad7"],
      "TR": ["KeyE", "Numpad9"],
      "BL": ["KeyS", "Numpad1"],
      "BR": ["KeyD", "Numpad3"]
    };

    const Sin60 = Math.sin(Math.PI/3);

    const _DIR_DELTA = {
      "TL": {x: -10 * 0.5, y: -10 * Sin60 },
      "TR": {x:  10 * 0.5, y: -10 * Sin60 },
      "BL": {x: -10 * 0.5, y:  10 * Sin60 },
      "BR": {x:  10 * 0.5, y:  10 * Sin60 },
    };

    class PolySnake extends Polymer.Element {
      static get is() { return 'poly-snake' }

      static get config() {
        return {
          properties: {
            snake: {
              type: Array,
              value: [{
                direction: "TR",
                x: 256,
                y: 256,
                color: 'red'
              }]
            },
            direction: {
              type: String,
              value: "TR"
            }
          }
        };
      }

      connectedCallback() {
        super.connectedCallback();

        this.notifyPath('snake');

        let evtDetail = {
          value: this.snake,
          queueProperty: true,
          path: 'snake'
        }

        setInterval(_ => {
          this.unshift('snake',this.newPart(this.snake[0], this.direction));
          if(this.snake.length>=10)
            this.pop('snake');
          this.snake[this.snake.length-1].color = 'white';
        }, 250);

        this.ctx = this.$.canvas.getContext('2d');

        requestAnimationFrame(this._installListeners.bind(this));
      }

      newPart(prevPart, direction) {
        return {
          direction: this.direction,
          x: prevPart.x + (direction ? _DIR_DELTA[direction].x : 0),
          y: prevPart.y + (direction ? _DIR_DELTA[direction].y : 0),
          color: ['#f0f','#00f','#ddd'][Math.floor(3*Math.random())]
        }
      }

      _installListeners() {
        console.log(document);
        document.addEventListener('keydown', evt => {
          if(!evt.repeat) {
            console.log('down', evt);
            for(let dir in _KEY_DIR) {
              if(_KEY_DIR[dir].includes(evt.code)) {
                this.direction = dir;
                break;
              }
            }
          }
        });
        document.addEventListener('keyup', evt => {
          console.log('up', evt);
        });
      }
    }

    customElements.define(PolySnake.is, PolySnake);

  </script>
</dom-module>
